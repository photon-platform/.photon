#!/usr/bin/env bash

alias serve="php -S localhost:${PORT} system/router.php"
alias local="open ${LOCAL}"
alias admin="open ${LOCAL}/admin"
alias server="open ${SERVER}"
alias edit="atom ${PROJECT_DIR}/user"
alias archive="cp -r ${PROJECT_DIR} ~/SITES/.archive/$PROJECT.$(date +"%Y%m%d")"

alias pr="cd ${PROJECT_DIR}"
alias th="cd $THEMES_DIR/photon;gss"
alias ch="cd $THEMES_DIR/photon-child;gss"
# alias pg="cd ${PROJECT_DIR}/user/pages;gss"
alias us="cd ${PROJECT_DIR}/user;gss"

alias cc="cd ${PROJECT_DIR};bin/grav clear-cache"



function pl() {
  if [ $1 ]
  then
    case $1 in

      new)
        pr
        bin/plugin photon newplugin
        ;;
      sub)
        # initialize a submodule
        if [ $2 ]
        then
          echo ""
          pl $2
          pl_sub $2
        else
          echo "format: pl sub pluginname"
        fi
        ;;

      *)
        # jump to plugin
        cd "$PLUGINS_DIR/photon-$1"
        head -n 2 blueprints.yaml
        echo
        git status -sb .
        ;;


    esac
  else
    cd $PLUGINS_DIR
    git status -sb .
  fi
}

function pg() {
  if [ $1 ]
  then
    case $1 in
      new)
        # if no second paramter for template - defualt to article
        TEMPLATE=${2-"article"}

        echo "photon âœ´ NEW $TEMPLATE"

        # get page title
        read -p "   TITLE: " TITLE

        # get page folder
        FOLDER=$(echo "$TITLE" | tr "[:upper:]" "[:lower:]" | tr "[:space:]" "-" | sed -e 's/-$//g' | sed -e 's/[,\/\?\.]//g')

        read -p "  FOLDER: " -i "$FOLDER" -e FOLDER

        # determine folder number
        NUM="00"
        read -p "     NUM: " -i "$NUM" -e NUM
        if [ $NUM ]
        then
          FOLDER="${NUM}.${FOLDER}"
        fi

        read -p "SUBTITLE: " SUBTITLE

        read -p " SUMMARY: " SUMMARY

        mkdir $FOLDER
        cd $FOLDER

        sed -e "s/:TITLE:/$TITLE/g" \
            -e "s/:SUBTITLE:/$SUBTITLE/g" \
            -e "s/:SUMMARY:/$SUMMARY/g" \
            ~/.photon/templates/$TEMPLATE.md > $TEMPLATE.md

        atom $TEMPLATE.md
        ;;
      *)
        echo "pg [new]"

        ;;
    esac
  else
    cd ${PROJECT_DIR}/user/pages
    ls
    git status -sb .
  fi
}

function pl_sub() {
  echo
  echo "*** checking github repo"
  git ls-remote -h https://github.com/photon-platform/grav-plugin-photon-$1.git HEAD
  echo Ctrl-C to quit - any key to continue?
  read

  echo
  echo "*** init and push"
  git init
  git add .
  git commit -m "convert to submodule"
  git remote add origin https://github.com/photon-platform/grav-plugin-photon-$1.git
  git push -fu origin master

  cd ..

  echo
  echo "*** remove from git"
  git rm -rf photon-$1

  echo
  echo "*** remove from files"
  rm -rf photon-$1

  echo
  echo "*** add repo as submodule"
  git submodule add --force https://github.com/photon-platform/grav-plugin-photon-$1.git photon-$1

  echo
  echo "*** update submodules within submodule"
  git submodule update --init --recursive

  echo
  echo "*** push to repo"


  git add .
  git commit -m "add submodule plugin: photon-$1"
  git push -fu origin master

  git gc --aggressive --prune=all
}
